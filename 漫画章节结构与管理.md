漫画章节结构与管理相关文档
## 章节结构迁移指南
### 概述
本指南说明如何将现有的错误章节结构迁移到正确的结构。

### 问题描述
**错误结构**:每个分镜画面(panel)被当作一个独立的章节
```
projects/
└── project_name/
    └── chapters/
        ├── chapter_001/  (实际是panel 1)
        ├── chapter_002/  (实际是panel 2)
        └── chapter_003/  (实际是panel 3)
```
**正确结构**:一个章节包含多个分镜画面
```
projects/
└── project_name/
    └── chapters/
        └── chapter_001/  (真正的第1章)
            ├── chapter_info.json  (章节信息)
            ├── panels.json        (分镜画面列表)
            ├── script.json        (分镜脚本)
            ├── images/            (所有分镜图像)
            └── panels/            (分镜相关文件)
```

### 迁移步骤
#### 1. 准备工作
1. **停止应用服务**
   ```bash
   # 停止后端服务
   pkill -f uvicorn
   # 停止前端服务(如果在运行)
   cd frontend && npm stop
   ```
2. **进入项目根目录**
   ```bash
   cd /home/vivy/novel-comic-maker
   ```

#### 2. 创建备份
```bash
cd backend
python scripts/migrate_chapter_structure.py --backup --projects-dir ../projects
```
这会在项目根目录创建 `projects_backup` 目录,包含所有项目的完整备份。

#### 3. 执行迁移
##### 迁移所有项目
```bash
python scripts/migrate_chapter_structure.py --migrate --projects-dir ../projects
```
##### 迁移特定项目
```bash
python scripts/migrate_chapter_structure.py --migrate --project "2025.10.26_00.40_疯狂山脉" --projects-dir ../projects
```

#### 4. 验证迁移结果
迁移完成后,检查以下内容:
1. **目录结构**
   ```bash
   ls -la projects/2025.10.26_00.40_疯狂山脉/chapters/
   # 应该看到 chapter_001 目录(而不是多个章节)
   ls -la projects/2025.10.26_00.40_疯狂山脉/chapters/chapter_001/
   # 应该看到:chapter_info.json, panels.json, script.json, images/, panels/
   ```
2. **文件内容**
   ```bash
   # 检查章节信息
   cat projects/2025.10.26_00.40_疯狂山脉/chapters/chapter_001/chapter_info.json
   # 检查分镜画面
   cat projects/2025.10.26_00.40_疯狂山脉/chapters/chapter_001/panels.json
   ```
3. **图像文件**
   ```bash
   ls -la projects/2025.10.26_00.40_疯狂山脉/chapters/chapter_001/images/
   # 应该看到所有分镜图像文件
   ```

#### 5. 重启服务
```bash
# 重启后端服务
cd /home/vivy/novel-comic-maker/backend
uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
# 重启前端服务(如果需要)
cd /home/vivy/novel-comic-maker/frontend
npm start &
```

### 迁移脚本详解
#### 脚本功能
1. **备份功能**:完整备份现有项目目录
2. **迁移功能**:
   - 将多个章节目录合并为一个章节
   - 创建正确的目录结构
   - 迁移图像文件并重新命名
   - 提取和重组数据
   - 删除旧的章节目录
3. **回滚功能**:恢复备份

#### 数据转换
**原始数据**:
```
chapter_001/comic.json: { script: {...}, images: [{ panel_id: 1, confirmed: false }] }
chapter_001/images/scene_option_1_xxx.png
```
**转换后数据**:
```
chapter_001/chapter_info.json: { chapter_id: "chapter_001", title: "第1章", ... }
chapter_001/panels.json: { panels: [{ panel_id: 1, description: "...", confirmed: false, ... }] }
chapter_001/images/scene_option_0_xxx.png
```

### 故障排除
#### 常见问题
1. **迁移失败**
   - 检查日志输出中的错误信息
   - 确保有足够的磁盘空间
   - 确保文件权限正确
2. **数据丢失**
   - 使用备份恢复:`python scripts/migrate_chapter_structure.py --rollback`
   - 检查备份目录是否完整
3. **前端显示异常**
   - 清除浏览器缓存
   - 检查API返回的数据格式
   - 确认新的数据结构正确

#### 调试方法
1. **查看详细日志**
   ```bash
   python scripts/migrate_chapter_structure.py --migrate 2>&1 | tee migration.log
   ```
2. **验证数据结构**
   ```python
   # 在Python中验证
   import json
   with open('projects/xxx/chapters/chapter_001/panels.json') as f:
       data = json.load(f)
       print(json.dumps(data, indent=2, ensure_ascii=False))
   ```

### 注意事项
1. **备份数据**:迁移前必须创建备份
2. **停服操作**:迁移期间确保服务停止
3. **测试验证**:迁移后仔细验证数据完整性
4. **逐步进行**:建议先在测试环境验证脚本

### 迁移后的优势
1. **正确的数据结构**:符合漫画创作的实际流程
2. **更好的性能**:减少API调用次数
3. **清晰的用户界面**:章节与分镜画面层次分明
4. **便于扩展**:支持更复杂的漫画管理功能

### 联系支持
如果在迁移过程中遇到问题,请:
1. 保存详细的错误日志
2. 记录迁移前的数据状态
3. 联系开发团队获取支持

---
**重要提醒**:在生产环境中执行迁移前,强烈建议先在测试环境中完整验证迁移流程。


## 漫画管理功能说明
### 概述
漫画管理功能已替代原有的工作流编排功能,为用户提供了完整的漫画内容管理界面。用户可以通过该功能查看、编辑、导出和管理通过AI生成的漫画内容。

### 主要功能
#### 1. 章节管理
- **章节列表**: 显示项目中的所有章节,每个章节对应用户上传的一段小说内容
- **章节状态**: 显示章节的生成状态(已完成、生成中、错误等)
- **章节统计**: 统计每个章节的画面数量和确认状态

#### 2. 画面分组显示
- **已确认画面**: 用户确认满意的画面,可以用于最终导出
- **待确认画面**: 新生成的画面,用户可以选择确认或重新生成
- **画面预览**: 点击画面可以查看大图预览

#### 3. 搜索和筛选
- **章节搜索**: 按章节标题或ID搜索
- **状态筛选**: 按章节状态筛选(全部、已完成、生成中、错误)
- **排序功能**: 支持按创建时间、标题、状态排序,可升降序切换

#### 4. 删减功能
- **删除章节**: 删除整个章节及其所有内容
- **删除画面**: 删除章节中的特定画面
- **批量操作**: 支持批量选择和删除多个画面

#### 5. 重新生成功能
- **整章重新生成**: 重新生成整个章节的内容
- **选择性重新生成**: 仅重新生成选定的画面
- **风格调整**: 支持在重新生成时添加风格修改要求

#### 6. 导出功能
- **格式选择**: 支持导出为PDF、图片包、压缩包
- **质量控制**: 支持不同分辨率和质量设置
- **选择性导出**: 可选择只导出已确认的画面

### 使用界面
#### 导航路径
```
项目列表 → 选择项目 → 漫画管理标签页
或直接访问: /project/:id/comics
```

#### 界面布局
1. **顶部操作栏**: 返回按钮、全选/批量导出按钮
2. **搜索筛选栏**: 搜索框、状态筛选器、排序选项
3. **统计卡片**: 显示章节数量、完成情况等统计信息
4. **章节列表**:
   - 章节基本信息卡片(标题、状态、创建时间等)
   - 可展开查看章节内的所有画面
   - 已确认和待确认画面分组显示

#### 操作流程
1. **查看章节**: 在章节列表中浏览所有章节
2. **查看画面**: 点击章节展开,查看所有生成的画面
3. **确认画面**: 对满意的画面点击确认按钮
4. **删减内容**: 选择不需要的画面或章节进行删除
5. **重新生成**: 对不满意的画面选择重新生成
6. **导出作品**: 选择满意的内容导出为最终作品

### 技术特性
#### 前端实现
- **React + TypeScript**: 使用现代前端技术栈
- **Material-UI**: 提供一致的用户界面体验
- **React Query**: 高效的数据获取和缓存管理
- **响应式设计**: 支持不同屏幕尺寸的设备

#### 后端API
- **RESTful API**: 标准的REST接口设计
- **异步处理**: 支持长时间的重新生成任务
- **文件系统管理**: 基于文件系统的高效存储

#### 数据模型
- **章节结构**: 每个章节包含脚本信息和多个画面
- **画面管理**: 每个画面有独立的确认状态和元信息
- **导出配置**: 灵活的导出选项和格式支持

### 用户价值
1. **直观管理**: 清晰的界面让用户轻松管理大量漫画内容
2. **质量可控**: 通过确认机制确保最终输出的质量
3. **灵活操作**: 支持精细的内容控制和重新生成
4. **高效导出**: 多种格式和选项满足不同需求
5. **状态追踪**: 清晰的状态显示帮助用户了解进度

### 注意事项
1. **数据安全**: 删除操作不可恢复,请谨慎操作
2. **存储空间**: 大量漫画内容可能占用较多存储空间
3. **网络依赖**: 重新生成功能需要稳定的网络连接
4. **浏览器兼容**: 建议使用现代浏览器以获得最佳体验

### 未来扩展
该功能为后续的漫画编辑、协作分享、版本管理等高级功能奠定了基础,可以进一步增强用户的创作体验。


## 漫画生成工作流 - Agent设计文档(5. 章节管理专家 Agent)
### 5. 章节管理专家 Agent
#### 角色定位
你是一位专业的漫画章节管理专家,负责合理规划章节结构、管理剧情节奏,并确保章节间的逻辑连贯性和叙事流畅性。

#### 核心职责
1. **章节规划**:根据用户需求和故事内容合理划分章节
2. **节奏控制**:管理剧情推进的节奏和张力
3. **连贯性维护**:确保章节间的逻辑衔接和情节连贯
4. **前情回顾管理**:生成和维护每章的前情回顾内容

#### 工作流程
##### 1. 章节规划阶段
- **用户需求分析**:
  - 了解用户期望的每章页数设置
  - 分析故事的整体长度和复杂度
  - 确定章节划分的基本原则
  - 平衡叙事节奏和用户阅读习惯
- **结构规划**:
  - 根据大纲确定关键剧情节点
  - 合理分配各章节的内容比重
  - 设计章节间的悬念和转折点
  - 确保每章都有相对完整的叙事单元

##### 2. 内容分配阶段
- **剧本分配**:
  - 将总剧本按章节进行合理切分
  - 确保每个章节的叙事完整性
  - 处理章节间的信息传递和衔接
  - 预留必要的伏笔和呼应
- **页数规划**:
  - 根据用户设定的每章页数进行规划
  - 合理分配对话、动作、场景的篇幅
  - 预留重要情节足够的展开空间
  - 控制信息密度,避免过度压缩

##### 3. 连贯性管理阶段
- **逻辑衔接**:
  - 检查章节间的因果关系
  - 确保人物行为和动机的合理性
  - 验证时间线和空间关系的连贯
  - 处理跨章节的人物关系变化
- **情节呼应**:
  - 建立章节间的伏笔回收机制
  - 确保重要线索的连续性
  - 处理人物成长和关系发展的渐进性
  - 维护主题思想的贯穿性

##### 4. 前情回顾管理
- **回顾内容生成**:
  - 提取前章节的关键情节信息
  - 生成简洁有效的前情回顾文本
  - 确保新读者能够理解剧情
  - 避免剧透关键转折和悬念
- **预览内容制作**:
  - 为每章生成吸引人的章节简介
  - 创建章节封面的主题描述
  - 提供下章节的预告信息
  - 引导读者的阅读期待

#### 输出格式
```
### 章节规划报告:[项目名称]
**基本设置**:
- 总章节数:[计划章节数]
- 每章页数:[用户设定页数]
- 预计总页数:[计算得出的总页数]
- 更新频率:[建议的更新频率]
**章节结构**:
**第[数字]章:[章节标题]**
- 页数范围:[起始页-结束页]
- 主要内容:[章节主要内容概述]
- 关键事件:[重要情节节点]
- 涉及角色:[出场的主要角色]
- 与前章关系:[与前章节的连接]
**节奏分析**:
- 起承转合:[每个章节在整体结构中的作用]
- 高潮分布:[重要高潮情节的章节分布]
- 悬念设置:[悬念和转折点的安排]
- 平衡调整:[节奏平衡的建议调整]
### 章节[章节号]详细规划
**基本信息**:
- 章节标题:[章节名称]
- 计划页数:[本章页数]
- 预计完成时间:[创作时间预估]
**内容分配**:
- 开场(1-2页):[开场内容安排]
- 发展(X页):[主要剧情发展]
- 高潮(X页):[高潮情节安排]
- 结尾(1-2页):[结尾和悬念设置]
**前情回顾**:
[简明扼要的前情回顾文本,50-100字]
**章节简介**:
[吸引读者的章节简介,包含主要看点和悬念]
**封面建议**:
[章节封面的主题和视觉元素建议]
```

#### 章节划分原则
1. **叙事完整性**:每章都应该有相对完整的起承转合
2. **节奏合理性**:避免信息过度集中或分散
3. **悬念设置**:在合适的位置设置悬念吸引读者
4. **角色平衡**:合理安排主要角色的出场和发展
5. **主题贯穿**:确保每章都服务于整体主题

#### 质量控制要点
- **逻辑检查**:确保情节发展的合理性
- **连贯性验证**:检查章节间的衔接是否自然
- **节奏评估**:分析叙事节奏是否得当
- **读者体验**:从读者角度评估章节划分的合理性

#### 动态调整机制
- 根据创作进展动态调整章节规划
- 根据用户反馈优化章节结构
- 灵活处理创作过程中的新想法
- 保持整体结构的相对稳定性

#### 前端接口需求
需要预留以下前端调用接口:
- `plan_chapters(story_outline, pages_per_chapter, user_preferences)`
- `allocate_content(chapter_plan, total_content)`
- `generate_previous_summary(chapter_number, previous_events)`
- `create_chapter_preview(chapter_content, key_moments)`
- `adjust_chapter_structure(chapter_id, modification_request)`
- `get_chapter_overview(project_id)`